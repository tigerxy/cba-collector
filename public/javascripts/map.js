!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=34)}([function(e,t,n){var i=n(26).EventEmitter;t.EventEmitter=i,t.mixin=function(e){for(var t in i.prototype)e.prototype[t]=i.prototype[t]}},,function(e,t){var n,i,r=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function c(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{i="function"==typeof clearTimeout?clearTimeout:s}catch(e){i=s}}();var l,a=[],h=!1,u=-1;function p(){h&&l&&(h=!1,l.length?a=l.concat(a):u=-1,a.length&&f())}function f(){if(!h){var e=c(p);h=!0;for(var t=a.length;t;){for(l=a,a=[];++u<t;)l&&l[u].run();u=-1,t=a.length}l=null,h=!1,function(e){if(i===clearTimeout)return clearTimeout(e);if((i===s||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function v(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];a.push(new d(e,t)),1!==a.length||h||c(f)},d.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=v,r.addListener=v,r.once=v,r.off=v,r.removeListener=v,r.removeAllListeners=v,r.emit=v,r.prependListener=v,r.prependOnceListener=v,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,n){var i=new(n(27));e.exports=i},function(e,t,n){function i(e,t){i.super.call(this,t),this.code=e}n(28)(i),e.exports=i},function(e,t,n){t.defaultType=n(29).type,t.map={},t.register=function(e){e.name&&(t.map[e.name]=e),e.uri&&(t.map[e.uri]=e)},t.register(t.defaultType)},,,function(e,t,n){(function(t){var i=n(0),r=n(3),o=n(4),s=n(5);function c(e,t,n){i.EventEmitter.call(this),this.connection=e,this.collection=t,this.id=n,this.version=null,this.type=null,this.data=void 0,this.inflightFetch=[],this.inflightSubscribe=[],this.inflightUnsubscribe=[],this.pendingFetch=[],this.subscribed=!1,this.wantSubscribe=!1,this.inflightOp=null,this.pendingOps=[],this.type=null,this.applyStack=null,this.preventCompose=!1}function l(e,t,n){if(t){var i=e.pop();e.push(function(e){i&&i(e),n&&n(e)})}else e.push(n)}function a(e,t){if(e.del)return delete(n=t).op,delete n.create,void delete n.del;var n;if(t.del)return new o(4017,"Document was deleted");if(t.create)return new o(4018,"Document alredy created");if(t.op){if(e.create)return new o(4018,"Document already created");if(e.type.transformX){var i=e.type.transformX(e.op,t.op);e.op=i[0],t.op=i[1]}else{var r=e.type.transform(e.op,t.op,"left"),s=e.type.transform(t.op,e.op,"right");e.op=r,t.op=s}}}function h(e,t){for(var n=!1,i=0;i<e.length;i++){var r=e[i];r&&(r(t),n=!0)}return n}e.exports=c,i.mixin(c),c.prototype.destroy=function(e){var t=this;t.whenNothingPending(function(){t.wantSubscribe?t.unsubscribe(function(n){if(n)return e?e(n):t.emit("error",n);t.connection._destroyDoc(t),e&&e()}):(t.connection._destroyDoc(t),e&&e())})},c.prototype._setType=function(e){if("string"==typeof e&&(e=s.map[e]),e)this.type=e;else{if(null!==e){var t=new o(4008,"Missing type "+e);return this.emit("error",t)}this.type=e,this.data=void 0}},c.prototype.ingestSnapshot=function(e,t){if(!e)return t&&t();if("number"!=typeof e.v){var n=new o(5008,"Missing version in ingested snapshot. "+this.collection+"."+this.id);return t?t(n):this.emit("error",n)}if(this.type||this.hasWritePending()){if(null==this.version){if(this.hasWritePending())return t&&this.once("no write pending",t);n=new o(5009,"Cannot ingest snapshot in doc with null version. "+this.collection+"."+this.id);return t?t(n):this.emit("error",n)}return e.v>this.version?this.fetch(t):t&&t()}if(this.version>e.v)return t&&t();this.version=e.v;var i=void 0===e.type?s.defaultType:e.type;this._setType(i),this.data=this.type&&this.type.deserialize?this.type.deserialize(e.data):e.data,this.emit("load"),t&&t()},c.prototype.whenNothingPending=function(e){this.hasPending()?this.once("nothing pending",e):e()},c.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe.length||this.inflightUnsubscribe.length||this.pendingFetch.length)},c.prototype.hasWritePending=function(){return!(!this.inflightOp&&!this.pendingOps.length)},c.prototype._emitNothingPending=function(){this.hasWritePending()||(this.emit("no write pending"),this.hasPending()||this.emit("nothing pending"))},c.prototype._emitResponseError=function(e,t){if(t)return t(e),void this._emitNothingPending();this._emitNothingPending(),this.emit("error",e)},c.prototype._handleFetch=function(e,t){var n=this.inflightFetch.shift();if(e)return this._emitResponseError(e,n);this.ingestSnapshot(t,n),this._emitNothingPending()},c.prototype._handleSubscribe=function(e,t){var n=this.inflightSubscribe.shift();if(e)return this._emitResponseError(e,n);this.wantSubscribe&&(this.subscribed=!0),this.ingestSnapshot(t,n),this._emitNothingPending()},c.prototype._handleUnsubscribe=function(e){var t=this.inflightUnsubscribe.shift();if(e)return this._emitResponseError(e,t);t&&t(),this._emitNothingPending()},c.prototype._handleOp=function(e,t){if(e)return this.inflightOp?(4002===e.code&&(e=null),this._rollback(e)):this.emit("error",e);if(this.inflightOp&&t.src===this.inflightOp.src&&t.seq===this.inflightOp.seq)this._opAcknowledged(t);else if(null==this.version||t.v>this.version)this.fetch();else if(!(t.v<this.version)){if(this.inflightOp)if(i=a(this.inflightOp,t))return this._hardRollback(i);for(var n=0;n<this.pendingOps.length;n++){var i;if(i=a(this.pendingOps[n],t))return this._hardRollback(i)}this.version++;try{this._otApply(t,!1)}catch(e){return this._hardRollback(e)}}},c.prototype._onConnectionStateChanged=function(){if(this.connection.canSend)this.flush(),this._resubscribe();else if(this.inflightOp&&(this.pendingOps.unshift(this.inflightOp),this.inflightOp=null),this.subscribed=!1,(this.inflightFetch.length||this.inflightSubscribe.length)&&(this.pendingFetch=this.pendingFetch.concat(this.inflightFetch,this.inflightSubscribe),this.inflightFetch.length=0,this.inflightSubscribe.length=0),this.inflightUnsubscribe.length){var e=this.inflightUnsubscribe;this.inflightUnsubscribe=[],h(e)}},c.prototype._resubscribe=function(){var e=this.pendingFetch;if(this.pendingFetch=[],this.wantSubscribe)return e.length?void this.subscribe(function(t){h(e,t)}):void this.subscribe();e.length&&this.fetch(function(t){h(e,t)})},c.prototype.fetch=function(e){if(this.connection.canSend){var t=this.connection.sendFetch(this);l(this.inflightFetch,t,e)}else this.pendingFetch.push(e)},c.prototype.subscribe=function(e){if(this.wantSubscribe=!0,this.connection.canSend){var t=this.connection.sendSubscribe(this);l(this.inflightSubscribe,t,e)}else this.pendingFetch.push(e)},c.prototype.unsubscribe=function(e){if(this.wantSubscribe=!1,this.subscribed=!1,this.connection.canSend){var n=this.connection.sendUnsubscribe(this);l(this.inflightUnsubscribe,n,e)}else e&&t.nextTick(e)},c.prototype.flush=function(){this.connection.canSend&&!this.inflightOp&&!this.paused&&this.pendingOps.length&&this._sendOp()},c.prototype._otApply=function(e,t){if(e.op){if(!this.type)throw new o(4015,"Cannot apply op to uncreated document. "+this.collection+"."+this.id);if(!t&&this.type===s.defaultType&&e.op.length>1){this.applyStack||(this.applyStack=[]);for(var n=this.applyStack.length,i=0;i<e.op.length;i++){for(var r={op:[e.op[i]]},c=n;c<this.applyStack.length;c++){var l=a(this.applyStack[c],r);if(l)return this._hardRollback(l)}this.emit("before op",r.op,t),this.data=this.type.apply(this.data,r.op),this.emit("op",r.op,t)}return void this._popApplyStack(n)}return this.emit("before op",e.op,t),this.data=this.type.apply(this.data,e.op),void this.emit("op",e.op,t)}if(e.create)return this._setType(e.create.type),this.data=this.type.deserialize?this.type.createDeserialized?this.type.createDeserialized(e.create.data):this.type.deserialize(this.type.create(e.create.data)):this.type.create(e.create.data),void this.emit("create",t);if(e.del){var h=this.data;return this._setType(null),void this.emit("del",h,t)}},c.prototype._sendOp=function(){var e=this.connection.id;if(e){this.inflightOp||(this.inflightOp=this.pendingOps.shift());var t=this.inflightOp;if(!t){var n=new o(5010,"No op to send on call to _sendOp");return this.emit("error",n)}t.sentAt=Date.now(),t.retries=null==t.retries?0:t.retries+1,null==t.seq&&(t.seq=this.connection.seq++),this.connection.sendOp(this,t),null==t.src&&(t.src=e)}},c.prototype._submit=function(e,n,i){if(n||(n=!0),e.op){if(!this.type){var r=new o(4015,"Cannot submit op. Document has not been created. "+this.collection+"."+this.id);return i?i(r):this.emit("error",r)}this.type.normalize&&(e.op=this.type.normalize(e.op))}try{this._pushOp(e,i),this._otApply(e,n)}catch(e){return this._hardRollback(e)}var s=this;t.nextTick(function(){s.flush()})},c.prototype._pushOp=function(e,t){if(this.applyStack)this.applyStack.push(e);else{var n=this._tryCompose(e);if(n)return void n.callbacks.push(t)}e.type=this.type,e.callbacks=[t],this.pendingOps.push(e)},c.prototype._popApplyStack=function(e){if(e>0)this.applyStack.length=e;else{var t=this.applyStack[0];if(this.applyStack=null,t)if(-1!==(i=this.pendingOps.indexOf(t)))for(var n=this.pendingOps.splice(i),i=0;i<n.length;i++){t=n[i];var r=this._tryCompose(t);r?r.callbacks=r.callbacks.concat(t.callbacks):this.pendingOps.push(t)}}},c.prototype._tryCompose=function(e){if(!this.preventCompose){var t=this.pendingOps[this.pendingOps.length-1];if(t)return t.create&&e.op?(t.create.data=this.type.apply(t.create.data,e.op),t):t.op&&e.op&&this.type.compose?(t.op=this.type.compose(t.op,e.op),t):void 0}},c.prototype.submitOp=function(e,t,n){"function"==typeof t&&(n=t,t=null);var i={op:e},r=t&&t.source;this._submit(i,r,n)},c.prototype.create=function(e,t,n,i){if("function"==typeof t?(i=t,n=null,t=null):"function"==typeof n&&(i=n,n=null),t||(t=s.defaultType.uri),this.type){var r=new o(4016,"Document already exists");return i?i(r):this.emit("error",r)}var c={create:{type:t,data:e}},l=n&&n.source;this._submit(c,l,i)},c.prototype.del=function(e,t){if("function"==typeof e&&(t=e,e=null),!this.type){var n=new o(4015,"Document does not exist");return t?t(n):this.emit("error",n)}var i=e&&e.source;this._submit({del:!0},i,t)},c.prototype.pause=function(){this.paused=!0},c.prototype.resume=function(){this.paused=!1,this.flush()},c.prototype._opAcknowledged=function(e){if(this.inflightOp.create)this.version=e.v;else if(e.v!==this.version)return r.warn("Invalid version from server. Expected: "+this.version+" Received: "+e.v,e),this.fetch();this.version++,this._clearInflightOp()},c.prototype._rollback=function(e){var t=this.inflightOp;if(t.op&&t.type.invert){t.op=t.type.invert(t.op);for(var n=0;n<this.pendingOps.length;n++){var i=a(this.pendingOps[n],t);if(i)return this._hardRollback(i)}try{this._otApply(t,!1)}catch(e){return this._hardRollback(e)}this._clearInflightOp(e)}else this._hardRollback(e)},c.prototype._hardRollback=function(e){var t=[];this.inflightOp&&t.push(this.inflightOp),t=t.concat(this.pendingOps),this._setType(null),this.version=null,this.inflightOp=null,this.pendingOps=[];var n=this;this.fetch(function(){for(var i=!!t.length,r=0;r<t.length;r++)i=h(t[r].callbacks,e)&&i;if(e&&!i)return n.emit("error",e)})},c.prototype._clearInflightOp=function(e){var t=h(this.inflightOp.callbacks,e);if(this.inflightOp=null,this.flush(),this._emitNothingPending(),e&&!t)return this.emit("error",e)}}).call(this,n(2))},function(e,t){e.exports=function(e,t,n,i){var r=function(e,n,i,r){t(i,e,n,"left"),t(r,n,e,"right")},o=e.transformX=function(e,t){n(e),n(t);for(var s=[],c=0;c<t.length;c++){for(var l=t[c],a=[],h=0;h<e.length;){var u=[];if(r(e[h],l,a,u),h++,1!==u.length){if(0===u.length){for(var p=h;p<e.length;p++)i(a,e[p]);l=null;break}for(var f=o(e.slice(h),u),d=0;d<f[0].length;d++)i(a,f[0][d]);for(var v=0;v<f[1].length;v++)i(s,f[1][v]);l=null;break}l=u[0]}null!=l&&i(s,l),e=a}return[e,s]};e.transform=function(e,n,i){if("left"!==i&&"right"!==i)throw new Error("type must be 'left' or 'right'");return 0===n.length?e:1===e.length&&1===n.length?t([],e[0],n[0],i):"left"===i?o(e,n)[0]:o(n,e)[1]}}},function(e,t,n){(function(t){var i=n(0);function r(e,t,n,r,o,s,c){i.EventEmitter.call(this),this.action=e,this.connection=t,this.id=n,this.collection=r,this.query=o,this.results=null,s&&s.results&&(this.results=s.results,delete s.results),this.extra=void 0,this.options=s,this.callback=c,this.ready=!1,this.sent=!1}e.exports=r,i.mixin(r),r.prototype.hasPending=function(){return!this.ready},r.prototype.send=function(){if(this.connection.canSend){var e={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options&&(e.o=this.options),this.results){for(var t=[],n=0;n<this.results.length;n++){var i=this.results[n];t.push([i.id,i.version])}e.r=t}this.connection.send(e),this.sent=!0}},r.prototype.destroy=function(e){this.connection.canSend&&"qs"===this.action&&this.connection.send({a:"qu",id:this.id}),this.connection._destroyQuery(this),e&&t.nextTick(e)},r.prototype._onConnectionStateChanged=function(){this.connection.canSend&&!this.sent?this.send():this.sent=!1},r.prototype._handleFetch=function(e,t,n){this.connection._destroyQuery(this),this._handleResponse(e,t,n)},r.prototype._handleSubscribe=function(e,t,n){this._handleResponse(e,t,n)},r.prototype._handleResponse=function(e,t,n){var i=this.callback;if(this.callback=null,e)return this._finishResponse(e,i);if(!t)return this._finishResponse(null,i);var r=this,o=1,s=function(e){if(e)return r._finishResponse(e,i);--o||r._finishResponse(null,i)};if(Array.isArray(t))o+=t.length,this.results=this._ingestSnapshots(t,s),this.extra=n;else for(var c in t){o++;var l=t[c];this.connection.get(l.c||this.collection,c).ingestSnapshot(l,s)}s()},r.prototype._ingestSnapshots=function(e,t){for(var n=[],i=0;i<e.length;i++){var r=e[i],o=this.connection.get(r.c||this.collection,r.d);o.ingestSnapshot(r,t),n.push(o)}return n},r.prototype._finishResponse=function(e,t){if(this.emit("ready"),this.ready=!0,e)return this.connection._destroyQuery(this),t?t(e):this.emit("error",e);t&&t(null,this.results,this.extra)},r.prototype._handleError=function(e){this.emit("error",e)},r.prototype._handleDiff=function(e){for(var t=0;t<e.length;t++){"insert"===(n=e[t]).type&&(n.values=this._ingestSnapshots(n.values))}for(t=0;t<e.length;t++){var n;switch((n=e[t]).type){case"insert":var i=n.values;Array.prototype.splice.apply(this.results,[n.index,0].concat(i)),this.emit("insert",i,n.index);break;case"remove":var r=n.howMany||1,o=this.results.splice(n.index,r);this.emit("remove",o,n.index);break;case"move":r=n.howMany||1;var s=this.results.splice(n.from,r);Array.prototype.splice.apply(this.results,[n.to,0].concat(s)),this.emit("move",s,n.from,n.to)}}this.emit("changed",this.results)},r.prototype._handleExtra=function(e){this.extra=e,this.emit("extra",e)}}).call(this,n(2))},function(e,t){t.doNothing=function(){},t.hasKeys=function(e){for(var t in e)return!0;return!1},t.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},t.isValidVersion=function(e){return null===e||t.isInteger(e)&&e>=0}},,,,,,,,,,,,,function(e,t,n){t.Connection=n(25),t.Doc=n(8),t.Error=n(4),t.Query=n(10),t.types=n(5),t.logger=n(3)},function(e,t,n){(function(t){var i=n(8),r=n(10),o=n(32),s=n(0),c=n(4),l=n(5),a=n(11),h=n(3);function u(e){return 0===e.readyState||1===e.readyState?"connecting":"disconnected"}function p(e){s.EventEmitter.call(this),this.collections={},this.nextQueryId=1,this.nextSnapshotRequestId=1,this.queries={},this._snapshotRequests={},this.seq=1,this.id=null,this.agent=null,this.debug=!1,this.state=u(e),this.bindToSocket(e)}function f(e){return e.hasPending()}function d(e){return e.hasWritePending()}e.exports=p,s.mixin(p),p.prototype.bindToSocket=function(e){this.socket&&(this.socket.close(),this.socket.onmessage=null,this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null),this.socket=e;var n=u(e);this._setState(n),this.canSend=!1;var i=this;e.onmessage=function(e){try{var n="string"==typeof e.data?JSON.parse(e.data):e.data}catch(t){return void h.warn("Failed to parse message",e)}i.debug&&h.info("RECV",JSON.stringify(n));var r={data:n};if(i.emit("receive",r),r.data)try{i.handleMessage(r.data)}catch(e){t.nextTick(function(){i.emit("error",e)})}},e.onopen=function(){i._setState("connecting")},e.onerror=function(e){i.emit("connection error",e)},e.onclose=function(e){"closed"===e||"Closed"===e?i._setState("closed",e):"stopped"===e||"Stopped by server"===e?i._setState("stopped",e):i._setState("disconnected",e)}},p.prototype.handleMessage=function(e){var t=null;switch(e.error&&((t=new Error(e.error.message)).code=e.error.code,t.data=e,delete e.error),e.a){case"init":return 1!==e.protocol?(t=new c(4019,"Invalid protocol version"),this.emit("error",t)):l.map[e.type]!==l.defaultType?(t=new c(4020,"Invalid default type"),this.emit("error",t)):"string"!=typeof e.id?(t=new c(4021,"Invalid client id"),this.emit("error",t)):(this.id=e.id,void this._setState("connected"));case"qf":return void((n=this.queries[e.id])&&n._handleFetch(t,e.data,e.extra));case"qs":return void((n=this.queries[e.id])&&n._handleSubscribe(t,e.data,e.extra));case"qu":return;case"q":var n;if(!(n=this.queries[e.id]))return;return t?n._handleError(t):(e.diff&&n._handleDiff(e.diff),void(e.hasOwnProperty("extra")&&n._handleExtra(e.extra)));case"bf":return this._handleBulkMessage(e,"_handleFetch");case"bs":return this._handleBulkMessage(e,"_handleSubscribe");case"bu":return this._handleBulkMessage(e,"_handleUnsubscribe");case"nf":return this._handleSnapshotFetch(t,e);case"f":return void((i=this.getExisting(e.c,e.d))&&i._handleFetch(t,e.data));case"s":return void((i=this.getExisting(e.c,e.d))&&i._handleSubscribe(t,e.data));case"u":return void((i=this.getExisting(e.c,e.d))&&i._handleUnsubscribe(t));case"op":var i;return void((i=this.getExisting(e.c,e.d))&&i._handleOp(t,e));default:h.warn("Ignoring unrecognized message",e)}},p.prototype._handleBulkMessage=function(e,t){if(e.data)for(var n in e.data){(r=this.getExisting(e.c,n))&&r[t](e.error,e.data[n])}else if(Array.isArray(e.b))for(var i=0;i<e.b.length;i++){n=e.b[i];(r=this.getExisting(e.c,n))&&r[t](e.error)}else if(e.b)for(var n in e.b){var r;(r=this.getExisting(e.c,n))&&r[t](e.error)}else h.error("Invalid bulk message",e)},p.prototype._reset=function(){this.seq=1,this.id=null,this.agent=null},p.prototype._setState=function(e,t){if(this.state!==e){if("connecting"===e&&"disconnected"!==this.state&&"stopped"!==this.state&&"closed"!==this.state||"connected"===e&&"connecting"!==this.state){var n=new c(5007,"Cannot transition directly from "+this.state+" to "+e);return this.emit("error",n)}for(var i in this.state=e,this.canSend="connected"===e,"disconnected"!==e&&"stopped"!==e&&"closed"!==e||this._reset(),this.startBulk(),this.queries){this.queries[i]._onConnectionStateChanged()}for(var r in this.collections){var o=this.collections[r];for(var i in o)o[i]._onConnectionStateChanged()}for(var i in this._snapshotRequests){this._snapshotRequests[i]._onConnectionStateChanged()}this.endBulk(),this.emit(e,t),this.emit("state",e,t)}},p.prototype.startBulk=function(){this.bulk||(this.bulk={})},p.prototype.endBulk=function(){if(this.bulk)for(var e in this.bulk){var t=this.bulk[e];this._sendBulk("f",e,t.f),this._sendBulk("s",e,t.s),this._sendBulk("u",e,t.u)}this.bulk=null},p.prototype._sendBulk=function(e,t,n){if(n){var i,r=[],o={},s=0;for(var c in n){var l=n[c];null==l?r.push(c):(o[c]=l,i=c,s++)}if(1===r.length){c=r[0];this.send({a:e,c:t,d:c})}else r.length&&this.send({a:"b"+e,c:t,b:r});if(1===s){var a=o[i];this.send({a:e,c:t,d:i,v:a})}else s&&this.send({a:"b"+e,c:t,b:o})}},p.prototype._sendAction=function(e,t,n){if(this._addDoc(t),this.bulk){var i=this.bulk[t.collection]||(this.bulk[t.collection]={}),r=i[e]||(i[e]={}),o=r.hasOwnProperty(t.id);return r[t.id]=n,o}var s={a:e,c:t.collection,d:t.id,v:n};this.send(s)},p.prototype.sendFetch=function(e){return this._sendAction("f",e,e.version)},p.prototype.sendSubscribe=function(e){return this._sendAction("s",e,e.version)},p.prototype.sendUnsubscribe=function(e){return this._sendAction("u",e)},p.prototype.sendOp=function(e,t){this._addDoc(e);var n={a:"op",c:e.collection,d:e.id,v:e.version,src:t.src,seq:t.seq};t.op&&(n.op=t.op),t.create&&(n.create=t.create),t.del&&(n.del=t.del),this.send(n)},p.prototype.send=function(e){this.debug&&h.info("SEND",JSON.stringify(e)),this.emit("send",e),this.socket.send(JSON.stringify(e))},p.prototype.close=function(){this.socket.close()},p.prototype.getExisting=function(e,t){if(this.collections[e])return this.collections[e][t]},p.prototype.get=function(e,t){var n=this.collections[e]||(this.collections[e]={}),r=n[t];return r||(r=n[t]=new i(this,e,t),this.emit("doc",r)),r},p.prototype._destroyDoc=function(e){var t=this.collections[e.collection];t&&(delete t[e.id],a.hasKeys(t)||delete this.collections[e.collection])},p.prototype._addDoc=function(e){var t=this.collections[e.collection];t||(t=this.collections[e.collection]={}),t[e.id]!==e&&(t[e.id]=e)},p.prototype._createQuery=function(e,t,n,i,o){var s=this.nextQueryId++,c=new r(e,this,s,t,n,i,o);return this.queries[s]=c,c.send(),c},p.prototype._destroyQuery=function(e){delete this.queries[e.id]},p.prototype.createFetchQuery=function(e,t,n,i){return this._createQuery("qf",e,t,n,i)},p.prototype.createSubscribeQuery=function(e,t,n,i){return this._createQuery("qs",e,t,n,i)},p.prototype.hasPending=function(){return!!(this._firstDoc(f)||this._firstQuery(f)||this._firstSnapshotRequest())},p.prototype.hasWritePending=function(){return!!this._firstDoc(d)},p.prototype.whenNothingPending=function(e){var n=this._firstDoc(f);if(n)n.once("nothing pending",this._nothingPendingRetry(e));else{var i=this._firstQuery(f);if(i)i.once("ready",this._nothingPendingRetry(e));else{var r=this._firstSnapshotRequest();r?r.once("ready",this._nothingPendingRetry(e)):t.nextTick(e)}}},p.prototype._nothingPendingRetry=function(e){var n=this;return function(){t.nextTick(function(){n.whenNothingPending(e)})}},p.prototype._firstDoc=function(e){for(var t in this.collections){var n=this.collections[t];for(var i in n){var r=n[i];if(e(r))return r}}},p.prototype._firstQuery=function(e){for(var t in this.queries){var n=this.queries[t];if(e(n))return n}},p.prototype._firstSnapshotRequest=function(){for(var e in this._snapshotRequests)return this._snapshotRequests[e]},p.prototype.fetchSnapshot=function(e,t,n,i){"function"==typeof n&&(i=n,n=null);var r=this.nextSnapshotRequestId++,s=new o(this,r,e,t,n,i);this._snapshotRequests[s.requestId]=s,s.send()},p.prototype._handleSnapshotFetch=function(e,t){var n=this._snapshotRequests[t.id];n&&(delete this._snapshotRequests[t.id],n._handleResponse(e,t))}}).call(this,n(2))},function(e,t){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(e){return"function"==typeof e}function r(e){return"object"==typeof e&&null!==e}function o(e){return void 0===e}e.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},n.prototype.emit=function(e){var t,n,s,c,l,a;if(this._events||(this._events={}),"error"===e&&(!this._events.error||r(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var h=new Error('Uncaught, unspecified "error" event. ('+t+")");throw h.context=t,h}if(o(n=this._events[e]))return!1;if(i(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:c=Array.prototype.slice.call(arguments,1),n.apply(this,c)}else if(r(n))for(c=Array.prototype.slice.call(arguments,1),s=(a=n.slice()).length,l=0;l<s;l++)a[l].apply(this,c);return!0},n.prototype.addListener=function(e,t){var s;if(!i(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,i(t.listener)?t.listener:t),this._events[e]?r(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,r(this._events[e])&&!this._events[e].warned&&(s=o(this._maxListeners)?n.defaultMaxListeners:this._maxListeners)&&s>0&&this._events[e].length>s&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(e,t){if(!i(t))throw TypeError("listener must be a function");var n=!1;function r(){this.removeListener(e,r),n||(n=!0,t.apply(this,arguments))}return r.listener=t,this.on(e,r),this},n.prototype.removeListener=function(e,t){var n,o,s,c;if(!i(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(s=(n=this._events[e]).length,o=-1,n===t||i(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(r(n)){for(c=s;c-- >0;)if(n[c]===t||n[c].listener&&n[c].listener===t){o=c;break}if(o<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(o,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},n.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(i(n=this._events[e]))this.removeListener(e,n);else if(n)for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},n.prototype.listeners=function(e){return this._events&&this._events[e]?i(this._events[e])?[this._events[e]]:this._events[e].slice():[]},n.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(i(t))return 1;if(t)return t.length}return 0},n.listenerCount=function(e,t){return e.listenerCount(t)}},function(e,t){var n=["info","warn","error"];function i(){this.setMethods(console)}e.exports=i,i.prototype.setMethods=function(e){e=e||{};var t=this;n.forEach(function(n){"function"==typeof e[n]&&(t[n]=e[n])})}},function(e,t,n){"use strict";var i="undefined"!=typeof Reflect?Reflect.construct:void 0,r=Object.defineProperty,o=Error.captureStackTrace;function s(e){void 0!==e&&r(this,"message",{configurable:!0,value:e,writable:!0});var t=this.constructor.name;void 0!==t&&t!==this.name&&r(this,"name",{configurable:!0,value:t,writable:!0}),o(this,this.constructor)}void 0===o&&(o=function(e){var t=new Error;r(e,"stack",{configurable:!0,get:function(){var e=t.stack;return r(this,"stack",{configurable:!0,value:e,writable:!0}),e},set:function(t){r(e,"stack",{configurable:!0,value:t,writable:!0})}})}),s.prototype=Object.create(Error.prototype,{constructor:{configurable:!0,value:s,writable:!0}});var c=function(){function e(e,t){return r(e,"name",{configurable:!0,value:t})}try{var t=function(){};if(e(t,"foo"),"foo"===t.name)return e}catch(e){}}();(e.exports=function(e,t){if(null==t||t===Error)t=s;else if("function"!=typeof t)throw new TypeError("super_ should be a function");var n;if("string"==typeof e)n=e,e=void 0!==i?function(){return i(t,arguments,this.constructor)}:function(){t.apply(this,arguments)},void 0!==c&&(c(e,n),n=void 0);else if("function"!=typeof e)throw new TypeError("constructor should be either a string or a function");e.super_=e.super=t;var r={constructor:{configurable:!0,value:e,writable:!0}};return void 0!==n&&(r.name={configurable:!0,value:n,writable:!0}),e.prototype=Object.create(t.prototype,r),e}).BaseError=s},function(e,t,n){e.exports={type:n(30)}},function(e,t,n){var i=function(e){return"[object Array]"==Object.prototype.toString.call(e)},r=function(e){return JSON.parse(JSON.stringify(e))},o={name:"json0",uri:"http://sharejs.org/types/JSONv0"},s={};function c(e){e.t="text0";var t={p:e.p.pop()};null!=e.si&&(t.i=e.si),null!=e.sd&&(t.d=e.sd),e.o=[t]}function l(e){e.p.push(e.o[0].p),null!=e.o[0].i&&(e.si=e.o[0].i),null!=e.o[0].d&&(e.sd=e.o[0].d),delete e.t,delete e.o}o.registerSubtype=function(e){s[e.name]=e},o.create=function(e){return void 0===e?null:r(e)},o.invertComponent=function(e){var t={p:e.p};return e.t&&s[e.t]&&(t.t=e.t,t.o=s[e.t].invert(e.o)),void 0!==e.si&&(t.sd=e.si),void 0!==e.sd&&(t.si=e.sd),void 0!==e.oi&&(t.od=e.oi),void 0!==e.od&&(t.oi=e.od),void 0!==e.li&&(t.ld=e.li),void 0!==e.ld&&(t.li=e.ld),void 0!==e.na&&(t.na=-e.na),void 0!==e.lm&&(t.lm=e.p[e.p.length-1],t.p=e.p.slice(0,e.p.length-1).concat([e.lm])),t},o.invert=function(e){for(var t=e.slice().reverse(),n=[],i=0;i<t.length;i++)n.push(o.invertComponent(t[i]));return n},o.checkValidOp=function(e){for(var t=0;t<e.length;t++)if(!i(e[t].p))throw new Error("Missing path")},o.checkList=function(e){if(!i(e))throw new Error("Referenced element not a list")},o.checkObj=function(e){if(!(t=e)||t.constructor!==Object)throw new Error("Referenced element not an object (it was "+JSON.stringify(e)+")");var t},o.apply=function(e,t){o.checkValidOp(t),t=r(t);for(var n={data:e},i=0;i<t.length;i++){var l=t[i];null==l.si&&null==l.sd||c(l);for(var a=null,h=n,u="data",p=0;p<l.p.length;p++){var f=l.p[p];if(a=h,u,h=h[u],u=f,null==a)throw new Error("Path invalid")}if(l.t&&void 0!==l.o&&s[l.t])h[u]=s[l.t].apply(h[u],l.o);else if(void 0!==l.na){if("number"!=typeof h[u])throw new Error("Referenced element not a number");h[u]+=l.na}else if(void 0!==l.li&&void 0!==l.ld)o.checkList(h),h[u]=l.li;else if(void 0!==l.li)o.checkList(h),h.splice(u,0,l.li);else if(void 0!==l.ld)o.checkList(h),h.splice(u,1);else if(void 0!==l.lm){if(o.checkList(h),l.lm!=u){var d=h[u];h.splice(u,1),h.splice(l.lm,0,d)}}else if(void 0!==l.oi)o.checkObj(h),h[u]=l.oi;else{if(void 0===l.od)throw new Error("invalid / missing instruction in op");o.checkObj(h),delete h[u]}}return n.data},o.shatter=function(e){for(var t=[],n=0;n<e.length;n++)t.push([e[n]]);return t},o.incrementalApply=function(e,t,n){for(var i=0;i<t.length;i++){var r=[t[i]];n(r,e=o.apply(e,r))}return e};var a=o.pathMatches=function(e,t,n){if(e.length!=t.length)return!1;for(var i=0;i<e.length;i++)if(e[i]!==t[i]&&(!n||i!==e.length-1))return!1;return!0};o.append=function(e,t){if(t=r(t),0!==e.length){var n=e[e.length-1];if(null==t.si&&null==t.sd||null==n.si&&null==n.sd||(c(t),c(n)),a(t.p,n.p))if(t.t&&n.t&&t.t===n.t&&s[t.t]){if(n.o=s[t.t].compose(n.o,t.o),null!=t.si||null!=t.sd){for(var i=t.p,o=0;o<n.o.length-1;o++)t.o=[n.o.pop()],t.p=i.slice(),l(t),e.push(t);l(n)}}else null!=n.na&&null!=t.na?e[e.length-1]={p:n.p,na:n.na+t.na}:void 0!==n.li&&void 0===t.li&&t.ld===n.li?void 0!==n.ld?delete n.li:e.pop():void 0!==n.od&&void 0===n.oi&&void 0!==t.oi&&void 0===t.od?n.oi=t.oi:void 0!==n.oi&&void 0!==t.od?void 0!==t.oi?n.oi=t.oi:void 0!==n.od?delete n.oi:e.pop():void 0!==t.lm&&t.p[t.p.length-1]===t.lm||e.push(t);else null==t.si&&null==t.sd||null==n.si&&null==n.sd||(l(t),l(n)),e.push(t)}else e.push(t)},o.compose=function(e,t){o.checkValidOp(e),o.checkValidOp(t);for(var n=r(e),i=0;i<t.length;i++)o.append(n,t[i]);return n},o.normalize=function(e){var t=[];e=i(e)?e:[e];for(var n=0;n<e.length;n++){var r=e[n];null==r.p&&(r.p=[]),o.append(t,r)}return t},o.commonLengthForOps=function(e,t){var n=e.p.length,i=t.p.length;if((null!=e.na||e.t)&&n++,(null!=t.na||t.t)&&i++,0===n)return-1;if(0===i)return null;n--,i--;for(var r=0;r<n;r++){var o=e.p[r];if(r>=i||o!==t.p[r])return null}return n},o.canOpAffectPath=function(e,t){return null!=o.commonLengthForOps({p:t},e)},o.transformComponent=function(e,t,n,a){t=r(t);var h=o.commonLengthForOps(n,t),u=o.commonLengthForOps(t,n),p=t.p.length,f=n.p.length;if((null!=t.na||t.t)&&p++,(null!=n.na||n.t)&&f++,null!=u&&f>p&&t.p[u]==n.p[u])if(void 0!==t.ld)(v=r(n)).p=v.p.slice(p),t.ld=o.apply(r(t.ld),[v]);else if(void 0!==t.od){(v=r(n)).p=v.p.slice(p),t.od=o.apply(r(t.od),[v])}if(null!=h){var d=p==f,v=n;if(null==t.si&&null==t.sd||null==n.si&&null==n.sd||(c(t),c(v=r(n))),v.t&&s[v.t]){if(t.t&&t.t===v.t){var g=s[t.t].transform(t.o,v.o,a);if(null!=t.si||null!=t.sd)for(var y=t.p,_=0;_<g.length;_++)t.o=[g[_]],t.p=y.slice(),l(t),o.append(e,t);else(!i(g)||g.length>0)&&(t.o=g,o.append(e,t));return e}}else if(void 0!==n.na);else if(void 0!==n.li&&void 0!==n.ld){if(n.p[h]===t.p[h]){if(!d)return e;if(void 0!==t.ld){if(void 0===t.li||"left"!==a)return e;t.ld=r(n.li)}}}else if(void 0!==n.li)void 0!==t.li&&void 0===t.ld&&d&&t.p[h]===n.p[h]?"right"===a&&t.p[h]++:n.p[h]<=t.p[h]&&t.p[h]++,void 0!==t.lm&&d&&n.p[h]<=t.lm&&t.lm++;else if(void 0!==n.ld){if(void 0!==t.lm&&d){if(n.p[h]===t.p[h])return e;y=n.p[h];var m=t.p[h];(y<(b=t.lm)||y===b&&m<b)&&t.lm--}if(n.p[h]<t.p[h])t.p[h]--;else if(n.p[h]===t.p[h]){if(f<p)return e;if(void 0!==t.ld){if(void 0===t.li)return e;delete t.ld}}}else if(void 0!==n.lm)if(void 0!==t.lm&&p===f){m=t.p[h];var b=t.lm,w=n.p[h],O=n.lm;if(w!==O)if(m===w){if("left"!==a)return e;t.p[h]=O,m===b&&(t.lm=O)}else m>w&&t.p[h]--,m>O?t.p[h]++:m===O&&w>O&&(t.p[h]++,m===b&&t.lm++),b>w?t.lm--:b===w&&b>m&&t.lm--,b>O?t.lm++:b===O&&(O>w&&b>m||O<w&&b<m?"right"===a&&t.lm++:b>m?t.lm++:b===w&&t.lm--)}else if(void 0!==t.li&&void 0===t.ld&&d){m=n.p[h],b=n.lm;(y=t.p[h])>m&&t.p[h]--,y>b&&t.p[h]++}else{m=n.p[h],b=n.lm;(y=t.p[h])===m?t.p[h]=b:(y>m&&t.p[h]--,y>b?t.p[h]++:y===b&&m>b&&t.p[h]++)}else if(void 0!==n.oi&&void 0!==n.od){if(t.p[h]===n.p[h]){if(void 0===t.oi||!d)return e;if("right"===a)return e;t.od=n.oi}}else if(void 0!==n.oi){if(void 0!==t.oi&&t.p[h]===n.p[h]){if("left"!==a)return e;o.append(e,{p:t.p,od:n.oi})}}else if(void 0!==n.od&&t.p[h]==n.p[h]){if(!d)return e;if(void 0===t.oi)return e;delete t.od}}return o.append(e,t),e},n(9)(o,o.transformComponent,o.checkValidOp,o.append);var h=n(31);o.registerSubtype(h),e.exports=o},function(e,t,n){var i=e.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(e){if(null!=e&&"string"!=typeof e)throw new Error("Initial data must be a string");return e||""}},r=function(e,t,n){return e.slice(0,t)+n+e.slice(t)},o=function(e){if("number"!=typeof e.p)throw new Error("component missing position field");if("string"==typeof e.i==("string"==typeof e.d))throw new Error("component needs an i or d field");if(e.p<0)throw new Error("position cannot be negative")},s=function(e){for(var t=0;t<e.length;t++)o(e[t])};i.apply=function(e,t){var n;s(t);for(var i=0;i<t.length;i++){var o=t[i];if(null!=o.i)e=r(e,o.p,o.i);else{if(n=e.slice(o.p,o.p+o.d.length),o.d!==n)throw new Error("Delete component '"+o.d+"' does not match deleted text '"+n+"'");e=e.slice(0,o.p)+e.slice(o.p+o.d.length)}}return e};var c=i._append=function(e,t){if(""!==t.i&&""!==t.d)if(0===e.length)e.push(t);else{var n=e[e.length-1];null!=n.i&&null!=t.i&&n.p<=t.p&&t.p<=n.p+n.i.length?e[e.length-1]={i:r(n.i,t.p-n.p,t.i),p:n.p}:null!=n.d&&null!=t.d&&t.p<=n.p&&n.p<=t.p+t.d.length?e[e.length-1]={d:r(t.d,n.p-t.p,n.d),p:t.p}:e.push(t)}};i.compose=function(e,t){s(e),s(t);for(var n=e.slice(),i=0;i<t.length;i++)c(n,t[i]);return n},i.normalize=function(e){var t=[];null==e.i&&null==e.p||(e=[e]);for(var n=0;n<e.length;n++){var i=e[n];null==i.p&&(i.p=0),c(t,i)}return t};var l=function(e,t,n){return null!=t.i?t.p<e||t.p===e&&n?e+t.i.length:e:e<=t.p?e:e<=t.p+t.d.length?t.p:e-t.d.length};i.transformCursor=function(e,t,n){for(var i="right"===n,r=0;r<t.length;r++)e=l(e,t[r],i);return e};var a=i._tc=function(e,t,n,i){if(o(t),o(n),null!=t.i)c(e,{i:t.i,p:l(t.p,n,"right"===i)});else if(null!=n.i){var r=t.d;t.p<n.p&&(c(e,{d:r.slice(0,n.p-t.p),p:t.p}),r=r.slice(n.p-t.p)),""!==r&&c(e,{d:r,p:t.p+n.i.length})}else if(t.p>=n.p+n.d.length)c(e,{d:t.d,p:t.p-n.d.length});else if(t.p+t.d.length<=n.p)c(e,t);else{var s={d:"",p:t.p};t.p<n.p&&(s.d=t.d.slice(0,n.p-t.p)),t.p+t.d.length>n.p+n.d.length&&(s.d+=t.d.slice(n.p+n.d.length-t.p));var a=Math.max(t.p,n.p),h=Math.min(t.p+t.d.length,n.p+n.d.length);if(t.d.slice(a-t.p,h-t.p)!==n.d.slice(a-n.p,h-n.p))throw new Error("Delete ops delete different text in the same region of the document");""!==s.d&&(s.p=l(s.p,n),c(e,s))}return e};i.invert=function(e){e=e.slice().reverse();for(var t=0;t<e.length;t++)e[t]=null!=(n=e[t]).i?{d:n.i,p:n.p}:{i:n.d,p:n.p};var n;return e},n(9)(i,a,s,c)},function(e,t,n){var i=n(33),r=n(11),o=n(0);function s(e,t,n,i,s,c){if(o.EventEmitter.call(this),"function"!=typeof c)throw new Error("Callback is required for SnapshotRequest");if(!r.isValidVersion(s))throw new Error("Snapshot version must be a positive integer or null");this.requestId=t,this.connection=e,this.id=i,this.collection=n,this.version=s,this.callback=c,this.sent=!1}e.exports=s,o.mixin(s),s.prototype.send=function(){if(this.connection.canSend){var e={a:"nf",id:this.requestId,c:this.collection,d:this.id,v:this.version};this.connection.send(e),this.sent=!0}},s.prototype._onConnectionStateChanged=function(){this.connection.canSend?this.sent||this.send():this.sent=!1},s.prototype._handleResponse=function(e,t){if(this.emit("ready"),e)return this.callback(e);var n=new i(this.id,t.v,t.type,t.data,null);this.callback(null,n)}},function(e,t){e.exports=function(e,t,n,i,r){this.id=e,this.v=t,this.type=n,this.data=i,this.m=r}},function(e,t,n){"use strict";n.r(t);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function r(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var o=function(){return function(e,t){this.target=t,this.type=e}}(),s=function(e){function t(t,n){var i=e.call(this,"error",n)||this;return i.message=t.message,i.error=t,i}return r(t,e),t}(o),c=function(e){function t(t,n,i){void 0===t&&(t=1e3),void 0===n&&(n="");var r=e.call(this,"close",i)||this;return r.wasClean=!0,r.code=t,r.reason=n,r}return r(t,e),t}(o),l=function(){if("undefined"!=typeof WebSocket)return WebSocket},a={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1},h=function(){function e(e,t,n){void 0===n&&(n={});var i=this;this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=void 0,this.onerror=void 0,this.onmessage=void 0,this.onopen=void 0,this._handleOpen=function(e){i._debug("open event");var t=i._options.minUptime,n=void 0===t?a.minUptime:t;clearTimeout(i._connectTimeout),i._uptimeTimeout=setTimeout(function(){return i._acceptOpen()},n),i._ws.binaryType=i._binaryType,i._messageQueue.forEach(function(e){return i._ws.send(e)}),i._messageQueue=[],i.onopen&&i.onopen(e),i._listeners.open.forEach(function(t){return i._callEventListener(e,t)})},this._handleMessage=function(e){i._debug("message event"),i.onmessage&&i.onmessage(e),i._listeners.message.forEach(function(t){return i._callEventListener(e,t)})},this._handleError=function(e){i._debug("error event",e.message),i._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),i.onerror&&i.onerror(e),i._debug("exec error listeners"),i._listeners.error.forEach(function(t){return i._callEventListener(e,t)}),i._connect()},this._handleClose=function(e){i._debug("close event"),i._clearTimeouts(),i._shouldReconnect&&i._connect(),i.onclose&&i.onclose(e),i._listeners.close.forEach(function(t){return i._callEventListener(e,t)})},this._url=e,this._protocols=t,this._options=n,this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce(function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e},0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){this._ws&&this._ws.readyState===this.OPEN?(this._debug("send",e),this._ws.send(e)):(this._debug("enqueue",e),this._messageQueue.push(e))},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(e){return e!==t}))},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,["RWS>"].concat(e))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?a.reconnectionDelayGrowFactor:t,i=e.minReconnectionDelay,r=void 0===i?a.minReconnectionDelay:i,o=e.maxReconnectionDelay,s=void 0===o?a.maxReconnectionDelay:o,c=r;return this._retryCount>0&&(c=r*Math.pow(n,this._retryCount-1))>s&&(c=s),this._debug("next delay",c),c},e.prototype._wait=function(){var e=this;return new Promise(function(t){setTimeout(t,e._getNextDelay())})},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options,n=t.maxRetries,i=void 0===n?a.maxRetries:n,r=t.connectionTimeout,o=void 0===r?a.connectionTimeout:r,s=t.WebSocket,c=void 0===s?l():s;if(this._retryCount>=i)this._debug("max retries reached",this._retryCount,">=",i);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),"function"!=typeof(h=c)||2!==h.CLOSING)throw Error("No valid WebSocket class provided");var h;this._wait().then(function(){return e._getNextUrl(e._url)}).then(function(t){e._closeCalled?e._connectLock=!1:(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new c(t,e._protocols):new c(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout(function(){return e._handleTimeout()},o))})}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new s(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new c(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}(),u=n(24),p=new h("ws://localhost/api/ws");function f(e,t){var n=$('<div class="alert alert-'+e+' alert-dismissible" role="alert">   <strong>'+t+'</strong>       <button class="close" type="button" data-dismiss="alert" aria-label="Close">           <span aria-hidden="true">&times;</span>       </button>');n.appendTo("#alert"),setTimeout(function(e){$(e[0]).alert("close")},5e3,n)}function d(e,t){t.forEach(t=>{e[1*(1==t.properties.yours||secLevel>1)].addData(t)})}new u.Connection(p).createSubscribeQuery("treespots",{},{},(e,t)=>{console.log(t)}),$.ajaxSetup({headers:{token:token}});var v=L.Icon.extend({options:{iconSize:[30,35],iconAnchor:[15,35],popupAnchor:[0,-37]}}),g=new v({iconUrl:"/images/tree_green.png"}),y=new v({iconUrl:"/images/tree_yellow.png"}),_=new v({iconUrl:"/images/tree_red.png"}),m=new v({iconUrl:"/images/tree_grey.png"}),b=L.map("map").fitWorld();L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(b);var w=L.circle([51,9],{radius:15e5});w.addTo(b);var O,S=function(e,t){var n;switch(e.properties.status[e.properties.status.length-1].action){case"remove":n=m;break;case"add":n=_;break;case"assigned":n=y;break;case"collected":n=g;break;default:n=m}return L.marker(t,{icon:n})},k=function(e,t){t.on("click",function(){P("edit",e)})},E=L.geoJSON([],{style:{color:"red",fill:!0,fillOpacity:0},onEachFeature:function(e,t){secLevel>1&&t.bindTooltip(e.properties.number+": "+e.properties.name,{sticky:!0,interactive:!0})}}),x=L.geoJSON([],{style:{color:"gray",opacity:.5,fill:!0,fillColor:"gray"}}),T=L.geoJSON([],{pointToLayer:S,onEachFeature:k}),C=L.geoJSON([],{pointToLayer:S,onEachFeature:k});L.control.layers({},{"Mein Gebiete":E,"Andere Gebiete":x,"Meine Bäume":T,"Andere Bäume":C}).addTo(b),b.addLayer(T),2!=secLevel&&(b.addLayer(E),b.addLayer(x),b.addLayer(C)),L.easyButton("fa-crosshairs",function(e,t){t.fitBounds(E.getBounds())}).addTo(b),L.easyButton("fa-question",function(e,t){$("#helpModal").modal("show")}).addTo(b),O=[x,E],$.getJSON("/api/area",function(){}).done(function(e){d(O,e),b.fitBounds(O[1*(O[1].getLayers().length>0)].getBounds())}).fail(function(e){console.error(e)}).always(function(){}),function e(t,n=0){$.getJSON("/api/tree?time="+n,function(){}).done(function(e){console.log(e),e.length>0&&d(t,e)}).fail(function(e){console.error(e.message)}).always(function(){n=Date.now(),setTimeout(function(){e(t,n)},3e4)})}([C,T]),b.locate({watch:!0,enableHighAccuracy:!0}),b.on("locationfound",function(e){var t=e.accuracy/2;w.setLatLng(e.latlng),w.setRadius(t)}),b.on("locationerror",function(e){console.error(e.message)});var R=L.centerCross();function P(e,t){R.setVisible(!1),$(".dialog").addClass("inactive"),$("#"+e+"Dialog").removeClass("inactive"),$("body").trigger(e,t)}b.addLayer(R),R.setVisible(!1),$(".openDialog").on("click",function(e){P(e.target.attributes.open.nodeValue)}),$("body").on("add",function(e){R.setVisible(!0),b.flyTo(w.getLatLng()),$("#add").off().on("click",function(e){var t,n;t=$("#size label.active input").prop("id"),n=b.getCenter(),$.post("/api/tree",{size:t,lon:n.lng,lat:n.lat}).done(function(){f("success","Haufen erfolgreich hinzugefügt.")}).fail(function(){f("danger","Fehler")}).always(function(){P("main")})})}),$("body").on("main",function(e){}),$("body").on("edit",function(e,t){var n;console.log(t),secLevel>=3&&((n=$("select#user")).empty(),$.getJSON("/api/user/collectors",function(){}).done(function(e){e.forEach(e=>{n.append('<option value="'+e._id+'">'+e.name+"</option>")})}).fail(function(){f("danger","Fehler")}).always(function(){}));var i=$("#editLog");i.empty();var r=t.properties.status;r.forEach(e=>{var t=new Date(e.time);i.append("<tr><td>"+t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()+"</td><td>"+e.action+"</td></tr>")}),secLevel<3&&"add"!=r[r.length-1].action?$("#delete").prop("disabled",!0):$("#delete").prop("disabled",!1).off().on("click",function(e){var n;n=t._id,$.ajax({url:"/api/tree/"+n,method:"delete"}).done(function(){f("success","Haufen erfolgreich gelöscht.")}).fail(function(){f("danger","Fehler")}).always(function(){P("main")})}),$("#collect").off().on("click",function(e){var n;n=t._id,$.ajax({url:"/api/tree/"+n,method:"post"}).done(function(){f("success","Haufen erfolgreich gesammelt.")}).fail(function(){f("danger","Fehler")}).always(function(){P("main")})}),$("#assign").off().on("click",function(e){var n,i;n=t._id,i=$("select#user").val(),$.post("/api/tree/"+n+"/"+i,{}).done(function(){f("success","Haufen User zugewiesen.")}).fail(function(){f("danger","Fehler")}).always(function(){})}),console.log(t.properties.size),$("#editSize").prop("aria-valuenow",t.properties.size).css("width",33*t.properties.size+"%").html(t.properties.size)})}]);